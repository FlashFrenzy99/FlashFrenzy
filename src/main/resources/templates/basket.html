<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/default_layout" lang="en">



<th:block layout:fragment="content">
    <script>
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        function buy(){
            const token = getCookieValue('Authorization')
            const key = parseJwt(token)['basket']
            console.log(key)

            $.ajax({
                type: 'POST',
                url: `/api/orders/`+key,
                success: function (response) {
                    window.location.reload();
                },
                error: function (request, status, error) {
                    alert("구매에 실패했습니다."+error.responseBody)
                    window.location.reload();
                }
            })




        }
    </script>
    <h1>Your Basket</h1>

    <table>
        <thead>
        <tr id="test">
            <th>Product ID</th>
            <th>Title</th>
            <th>Image</th>
            <th>Price</th>
            <th>Category 1</th>
            <th>Category 2</th>
            <th>Stock</th>
        </tr>
        </thead>
        <tbody>
        <!-- 반복문을 사용하여 리스트를 순회하고 각 항목을 표시 -->
        <tr th:each="product : ${basketProducts}">
            <td th:text="${product.basketProductId}"></td>
            <td th:text="${product.title}"></td>
            <td th:text="${product.image}"></td>
            <td>
                <img th:src="${product.image}" width="200" height="200">
            </td>
            <td th:text="${product.price}"></td>
            <td th:text="${product.category1}"></td>
            <td th:text="${product.category2}"></td>
            <td th:text="${product.stock}"></td>
            <td>
                <form action="#" th:action="@{/api/baskets/{id}(id = ${product.basketProductId})}" method="#"
                      th:method="delete">
                    <input type="hidden" name="_method" value="delete">
                    <button th:text="삭제하기"></button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
    <button type="button" onclick="buy();" th:text="구매하기"></button>
</th:block>
</html>